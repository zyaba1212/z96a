# Учёт этапов разработки проекта z96a

Файл ведётся для сохранения последовательности действий и объёма выполненной работы. При переходе на новый этап не переписывать проект «по-своему» — продолжать от текущего состояния.

**Принцип:** Выполнять работу последовательно, учитывая предыдущие этапы; не допускать разрушения проекта (не переписывать глобус, карту, авторизацию, контракты API без явной задачи).

---

## Этап 3 — ЗАВЕРШЁН

**Дата завершения:** 2025-02-20

### Что сделано на этапе 3

1. **Комментарии в коде**
   - Добавлены комментарии (JSDoc/описание назначения) во все основные исходные файлы проекта:
   - **App:** `src/app/layout.tsx`, `src/app/page.tsx`, `src/app/providers.tsx`, `src/app/predlozhit/page.tsx`, `src/app/propose/page.tsx`
   - **API:** `src/app/api/tile/route.ts`, `src/app/api/geocode/reverse/route.ts`, `src/app/api/geocode/search/route.ts`, `src/app/api/auth/route.ts`, `src/app/api/auth/verify/route.ts`
   - **Компоненты:** `src/components/EarthScene.tsx`, `src/components/HomePage.tsx`, `src/components/AuthBlock.tsx`, `src/components/MapView.tsx`
   - **Lib:** `src/lib/prisma.ts`, `src/lib/ui-root.ts`
   - Файл `next-env.d.ts` не редактировался (служебный Next.js).

2. **Файл учёта этапов**
   - Создан `PROJECT_STAGES.md` (этот файл) для фиксации объёма работ и последовательности этапов.

3. **Git**
   - Все изменения закоммичены и запушены на GitHub с сообщением о завершении этапа 3.

### Текущее состояние проекта (на конец этапа 3)

- **Главная страница:** глобус (Three.js) с текстурой Земли, границами стран, подписями, звёздным небом; кнопки «Вращение», «−», «+», «На карту».
- **Переход глобус ↔ 2D:** при приближении камеры до порога — автоматический переход на 2D-карту (Leaflet); тайлы через `/api/tile` (OSM/ESRI); при отдалении (zoom < 11) — возврат на глобус; кнопка «На глобус».
- **2D-режим:** поиск по адресу (`/api/geocode/search`), обратный геокод (`/api/geocode/reverse`), отображение текущего места, стрелки панорамирования (клавиши и кнопки), зум +/−.
- **Авторизация:** блок AuthBlock (Phantom), подпись сообщения, вызов `/api/auth/verify`, после входа — ссылка «Предложить» (/propose), кнопка «Выйти».
- **Страницы «Предложить»:** `/predlozhit` и `/propose` — заглушки до этапа 5 (режим редактирования сети).
- **БД:** Prisma, модель User (pubkey); используется в API auth и auth/verify.

### Что не менять при следующих этапах без явной задачи

- Структуру маршрутов (app router) и имена файлов страниц.
- Логику перехода глобус ↔ 2D (пороги, гистерезис) и API глобуса (GlobeControls).
- Контракты API: `/api/tile`, `/api/geocode/reverse`, `/api/geocode/search`, `/api/auth`, `/api/auth/verify`.
- Подключение Solana (Phantom) и формат авторизации (message + signature).

### Следующий этап

- Продолжать с **этапа 5** по плану проекта (режим «Предложение» — UI и поток). Не переписывать с нуля глобус, карту или авторизацию.

---

## Этап 4 — ЗАВЕРШЁН

**Дата завершения:** 2025-02-20

### Что сделано на этапе 4

1. **Принцип работы** — в начале файла и в `.cursor/rules/general.mdc` зафиксирован принцип: выполнять работу последовательно, учитывая предыдущие этапы; не допускать разрушения проекта.

2. **Модель данных сети (Prisma)**
   - `NetworkProvider`: имя, scope (GLOBAL | LOCAL), sourceUrl (официальный источник).
   - `NetworkElement`: scope, type (CABLE_COPPER | CABLE_FIBER | BASE_STATION | SATELLITE | EQUIPMENT), провайдер, name, точка (lat/lng) или кабель (path — JSON массив точек).
   - Схема синхронизирована с БД (`prisma db push`).

3. **API** — GET `/api/network?scope=GLOBAL|LOCAL` — возвращает элементы и провайдеров для визуализации. Существующие API не изменялись.

4. **Визуализация на глобусе (EarthScene)**
   - Загрузка `/api/network?scope=GLOBAL` после инициализации сцены.
   - Кабели: линии по path; цвет по design.md (медь — оранжевый, оптика — зелёный).
   - Узлы (БС, спутник, оборудование): малые сферы в точках lat/lng.
   - Очистка группы сети при размонтировании.

5. **Визуализация на 2D-карте**
   - При показе Leaflet-оверлея загрузка `/api/network` (все элементы); на карту выводятся глобальные кабели и узлы + локальные элементы (полилинии и circleMarker). Глобальные кабели отображаются и на 2D.

6. **Сидер и тестовые данные**
   - `prisma/seed.mjs`: глобальный и локальный провайдеры, примеры кабелей (CABLE_FIBER, CABLE_COPPER) и точек (BASE_STATION, SATELLITE, EQUIPMENT). Источник глобальных данных указан — TeleGeography.
   - В `package.json` добавлен скрипт и конфиг `prisma.seed`.

7. **Документация** — `docs/network-data-sources.md`: официальные источники для глобальной и локальной сети, обозначения по design.md.

### Текущее состояние проекта (на конец этапа 4)

- Всё из этапа 3 сохранено. Дополнительно:
- **Сеть на глобусе:** отображаются глобальные кабели (оранжевый/зелёный) и узлы (синие точки).
- **Сеть на 2D:** при переходе на карту отображаются те же глобальные элементы плюс локальные (провайдеры и элементы по scope).
- **БД:** таблицы NetworkProvider, NetworkElement; сидер заполняет тестовые данные.
- **Иконки:** узлы пока в виде сфер (глобус) и кружков (2D); детальные символы по ITU/ГОСТ можно добавить в следующих итерациях.
